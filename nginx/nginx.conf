http {
  upstream user {
    server user:8081;
    keepalive 16;
  }

  upstream chat {
    server chat:8082;
    keepalive 16;
  }

  upstream notification {
    server notification:8083;
    keepalive 16;
  }

  # Use Docker internal resolver so nginx can re-resolve service names when backends restart
  resolver 127.0.0.11 valid=30s ipv6=off;

  server {
    listen 85;

    # Global proxy tuning for resilience
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  # Ensure important request headers (content-type/length) are forwarded
  proxy_set_header Content-Type $http_content_type;
  proxy_set_header Content-Length $http_content_length;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_next_upstream_tries 3;

    location ~ ^/user/(.*)$ {
      # dynamic DNS resolution of the backend using Docker resolver
      set $upstream_user "user:8081";
      proxy_pass http://$upstream_user/$1$is_args$args;
      proxy_pass_request_body on;
      proxy_request_buffering on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/chat/(.*)$ {
      set $upstream_chat "chat:8082";
      proxy_pass http://$upstream_chat/$1$is_args$args;
      proxy_pass_request_body on;
      proxy_request_buffering on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/notifications/(.*)$ {
      set $upstream_notifications "notification:8083";
      proxy_pass http://$upstream_notifications/$1$is_args$args;
      proxy_pass_request_body on;
      proxy_request_buffering on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
}

events {}