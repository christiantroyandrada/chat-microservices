# GitHub Secrets Configuration

This document lists all the secrets required for the image-based CI/CD pipeline deployment.

## üöÄ New Deployment Architecture

This project now uses an **image-based deployment** approach:

1. **GitHub Actions builds Docker images** in the CI pipeline
2. **Images are pushed to GitHub Container Registry (GHCR)**
3. **VPS pulls pre-built images** (no git clone/pull on server)
4. **Source code is never stored on VPS** for security

## How to Add Secrets

1. Go to your GitHub repository
2. Click **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
3. Click **New repository secret**
4. Enter the name and value, then click **Add secret**

---

## Required GitHub Secrets

### VPS Connection Secrets

| Secret | Description | Required | Example |
|--------|-------------|----------|---------|
| `VPS_HOST` | IP address or domain of your VPS | ‚úÖ Yes | `192.168.1.100` |
| `VPS_USER` | SSH username with Docker permissions | ‚úÖ Yes | `deploy` |
| `VPS_SSH_PRIVATE_KEY` | Private SSH key for authentication | ‚úÖ Yes | See below |
| `VPS_PORT` | SSH port number | ‚ùå No | `22` (default) |
| `VPS_SUDO_PASSWORD` | Sudo password for privileged operations | ‚úÖ Yes | Your sudo password |

### GitHub Container Registry

The workflow uses the built-in `GITHUB_TOKEN` for GHCR authentication. **No manual setup required!**

`GITHUB_TOKEN` is automatically generated by GitHub Actions for every workflow run. The workflow already has `permissions: packages: write` which grants the token access to push images to GHCR.

### Infisical Secrets (Production Secret Management)

| Secret | Description | Required |
|--------|-------------|----------|
| `INFISCAL_CLIENT_ID` | Infisical machine identity client ID | ‚úÖ Yes |
| `INFISCAL_CLIENT_SECRET` | Infisical machine identity client secret | ‚úÖ Yes |
| `INFISCAL_PROJECT_SLUG` | Your Infisical project slug | ‚úÖ Yes |

> **Note**: The misspelling `INFISCAL_*` is intentional to match existing configuration.

### Optional Secrets

| Secret | Description | Default |
|--------|-------------|---------|
| `PGADMIN_EMAIL` | pgAdmin login email | `admin@admin.com` |

---

## Secrets Managed by Infisical

These secrets are stored in Infisical and fetched during deployment:

### Database Credentials
| Secret | Description | Validated |
|--------|-------------|-----------|
| `ADMIN_USERNAME` | PostgreSQL admin username | ‚úÖ Required |
| `ADMIN_PASSWORD` | PostgreSQL admin password | ‚úÖ Required |
| `ADMIN_PASSWORD_ENCODED` | URL-encoded password for connection strings | ‚úÖ Required |

### Email/SMTP Configuration
| Secret | Description | Default |
|--------|-------------|---------|
| `SMTP_HOST` | SMTP server hostname | `smtp-relay.brevo.com` |
| `SMTP_USER` | SMTP username | ‚ö†Ô∏è Warned if missing |
| `SMTP_PASS` | SMTP password | ‚ö†Ô∏è Warned if missing |
| `EMAIL_FROM` | Sender email address | `admin@ctaprojects.xyz` |
| `SENDINBLUE_APIKEY` | SendinBlue/Brevo API key | ‚ö†Ô∏è Warned if missing |

### Application Configuration
| Secret | Description |
|--------|-------------|
| `CORS_ORIGINS` | Allowed CORS origins |
| `MESSAGE_BROKER_URL` | RabbitMQ connection URL |
| `PUBLIC_API_URL` | Frontend API URL (for Docker build) |
| `PUBLIC_WS_URL` | Frontend WebSocket URL (for Docker build) |

---

## SSH Key Setup

### Generate SSH Key
```bash
# On your local machine or VPS
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/github_deploy

# Display private key (copy to GITHUB_TOKEN secret)
cat ~/.ssh/github_deploy

# Add public key to VPS authorized_keys
ssh-copy-id -i ~/.ssh/github_deploy.pub deploy@YOUR_VPS_IP
```

### Private Key Format
Copy the **entire** private key including headers:
```
-----BEGIN OPENSSH PRIVATE KEY-----
[key content]
-----END OPENSSH PRIVATE KEY-----
```

---

## Repository-Specific Secrets

### Backend Repository (`chat-user-microservice`)
- `VPS_HOST`, `VPS_USER`, `VPS_SSH_PRIVATE_KEY`, `VPS_PORT`
- `VPS_SUDO_PASSWORD`
- `INFISCAL_CLIENT_ID`, `INFISCAL_CLIENT_SECRET`, `INFISCAL_PROJECT_SLUG`
- `PGADMIN_EMAIL` (optional)
- `GITHUB_TOKEN` *(automatic - no setup needed)*

### Frontend Repository (`chat-microservices-frontend`)
- `VPS_HOST`, `VPS_USER`, `VPS_SSH_PRIVATE_KEY`, `VPS_PORT`
- `VPS_SUDO_PASSWORD`
- `INFISCAL_CLIENT_ID`, `INFISCAL_CLIENT_SECRET`, `INFISCAL_PROJECT_SLUG`
- `GITHUB_TOKEN` *(automatic - no setup needed)*

---

## Security Features

### Secret Masking
All sensitive values are masked in GitHub Actions logs using `::add-mask::`:
- Passwords (ADMIN_PASSWORD, VPS_SUDO_PASSWORD)
- API keys (SENDINBLUE_APIKEY, GITHUB_TOKEN)
- Encoded credentials (ADMIN_PASSWORD_ENCODED)

### Secure Credential Passing
- Sudo passwords passed via here-strings (`<<<`) instead of echo pipes
- Docker login uses `--password-stdin` with here-strings
- Stderr redirected to `/dev/null` to prevent accidental leaks

### Post-Deployment Cleanup
After deployment, the CI/CD pipeline automatically:
- Removes `.git` and `.github` directories
- Removes source code directories
- Prunes unused Docker images and containers

---

## Troubleshooting

### SSH Connection Failed
```bash
# Test SSH connection manually
ssh -i ~/.ssh/github_deploy -p 49152 deploy@YOUR_VPS_IP echo "Connected!"
```

### GHCR Authentication Failed
```bash
# Test GHCR login
echo "YOUR_GHCR_TOKEN" | docker login ghcr.io -u YOUR_USERNAME --password-stdin
```

### Missing Infisical Secrets
Check the GitHub Actions log for validation output:
```
‚úÖ ADMIN_USERNAME
‚úÖ ADMIN_PASSWORD
‚ö†Ô∏è SMTP_HOST missing (defaulting to smtp-relay.brevo.com)
```

---

## Related Documentation

- [Deployment Guide](./README.md)
- [Infisical Setup Guide](./INFISICAL_SETUP.md)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
