# Production overrides for docker-compose.yml
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This file:
#   - Sets NODE_ENV=production for all services
#   - Enables SSL nginx configuration via build arg
#   - Mounts Let's Encrypt certificate volumes
#   - Configures production URLs for frontend

services:
  user:
    environment:
      NODE_ENV: production

  chat:
    environment:
      NODE_ENV: production
      USER_SERVICE_URL: http://user:8081

  notification:
    environment:
      NODE_ENV: production

  frontend:
    environment:
      NODE_ENV: production
      ORIGIN: https://chat.ctaprojects.xyz
      # Runtime environment variables for SvelteKit $env/dynamic/public
      PUBLIC_API_URL: https://chat.ctaprojects.xyz
      PUBLIC_WS_URL: https://chat.ctaprojects.xyz
    build:
      context: ../chat-microservices-frontend
      dockerfile: Dockerfile
      args:
        # Use production build (https://chat.ctaprojects.xyz URLs)
        BUILD_ENV: production
        PUBLIC_API_URL: https://chat.ctaprojects.xyz
        PUBLIC_WS_URL: https://chat.ctaprojects.xyz

  # Production nginx with SSL configuration
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
      args:
        # Use production nginx config (SSL enabled)
        NGINX_ENV: production
    volumes:
      # Let's Encrypt certificates and ACME challenge files
      # These are generated by init-letsencrypt.sh on VPS
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro

  # pgAdmin configuration for production
  # Accessible via nginx reverse proxy at /pgadmin/
  pgadmin:
    # Remove direct port mapping in production - access via nginx only
    ports: !reset []
    expose:
      - "80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${ADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      # Required for running behind nginx reverse proxy at /pgadmin/
      SCRIPT_NAME: /pgadmin
