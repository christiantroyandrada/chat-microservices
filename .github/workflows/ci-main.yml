name: CI Pipeline[main]

on:
  push:
    branches: [main]

# Give this workflow the permissions required by called reusable workflows
# `security-audit.yml` requests `security-events: write`, so we must allow it here.
permissions:
  contents: read
  security-events: write

jobs:
  build:
    name: Build & Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout
        # Pinned to specific commit SHA for supply-chain security
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Use Node.js ${{ matrix.node-version }}
        # Pinned to specific commit SHA for supply-chain security
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ matrix.node-version }}

      - name: Build user-service
        working-directory: ./user-service
        run: |
          npm ci
          npm run build

      - name: Build chat-service
        working-directory: ./chat-service
        run: |
          npm ci
          npm run build

      - name: Build notification-service
        working-directory: ./notification-service
        run: |
          npm ci
          npm run build

      - name: Build gateway
        working-directory: ./gateway
        run: |
          npm ci
          npm run build || echo "Gateway build step skipped (no build script)"

      - name: Audit backends
        run: |
          npm audit --prefix user-service --audit-level=moderate || true
          npm audit --prefix chat-service --audit-level=moderate || true
          npm audit --prefix notification-service --audit-level=moderate || true
          npm audit --prefix gateway --audit-level=moderate || true

      - name: Summary
        run: echo "Backend Build completed successfully"

  # TypeScript type checking (runs for all branches)
  typescript-check:
    name: TypeScript Type Check
    needs: build
    uses: ./.github/workflows/typescript-check.yml

  # Security audit (only runs on main branch)
  security-audit:
    name: Security Audit
    needs: typescript-check
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    uses: ./.github/workflows/security-audit.yml
    secrets: inherit

  # Unit tests with coverage (only runs on main branch)
  unit-tests:
    name: Unit Tests & Coverage
    needs: security-audit
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/unit-tests.yml
    with:
      coverage: 'true'
    secrets: inherit

  # Deploy to VPS (only runs on main branch after tests pass)
  deploy:
    name: Deploy to VPS
    needs: unit-tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production-deployment
      cancel-in-progress: false

    steps:
      - name: Fetch secrets from Infisical
        id: infisical
        uses: Infisical/secrets-action@v1.0.7
        with:
          method: universal
          # Intentional  misspelling as INFISICAL was erroneously created in secrets
          client-id: ${{ secrets.INFISCAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISCAL_CLIENT_SECRET }}
          project-slug: ${{ secrets.INFISCAL_PROJECT_SLUG }}
          env-slug: prod
          secret-path: /

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262
        env:
          # Database credentials
          ADMIN_USERNAME: ${{ steps.infisical.outputs.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ steps.infisical.outputs.ADMIN_PASSWORD }}
          ADMIN_PASSWORD_ENCODED: ${{ steps.infisical.outputs.ADMIN_PASSWORD_ENCODED }}
          # Application secrets
          CORS_ORIGINS: ${{ steps.infisical.outputs.CORS_ORIGINS }}
          MESSAGE_BROKER_URL: ${{ steps.infisical.outputs.MESSAGE_BROKER_URL }}
          SENDINBLUE_APIKEY: ${{ steps.infisical.outputs.SENDINBLUE_APIKEY }}
          SMTP_PASS: ${{ steps.infisical.outputs.SMTP_PASS }}
          SMTP_USER: ${{ steps.infisical.outputs.SMTP_USER }}
          # Deployment config
          PGADMIN_EMAIL: ${{ secrets.PGADMIN_EMAIL || 'admin@admin.com' }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          command_timeout: 30m
          envs: ADMIN_USERNAME,ADMIN_PASSWORD,ADMIN_PASSWORD_ENCODED,CORS_ORIGINS,MESSAGE_BROKER_URL,SENDINBLUE_APIKEY,SMTP_PASS,SMTP_USER,PGADMIN_EMAIL
          script: |
            set -e
            export DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/chat-app' }}"
            
            # Environment variables are already exported by ssh-action via 'envs' parameter
            
            echo "üöÄ Starting backend deployment..."
            cd $DEPLOY_PATH/chat-microservices
            
            # Pull latest changes
            git fetch origin
            git reset --hard origin/main
            
            # Make deploy script executable
            chmod +x deploy/deploy-vps.sh
            
            # Run deployment script (env vars are already available)
            bash deploy/deploy-vps.sh

      - name: Verify deployment
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |
            set -e
            export DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/chat-app' }}"
            cd $DEPLOY_PATH/chat-microservices
            
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15
            
            # Check service status
            docker compose ps
            
            # Check if all critical services are healthy
            if docker compose ps | grep -E '(user|chat|notification|frontend|nginx)' | grep -q "unhealthy"; then
              echo "‚ùå Some services are unhealthy!"
              echo "üìã Service status:"
              docker compose ps
              echo "üìù Recent logs:"
              docker compose logs --tail=50
              exit 1
            fi
            
            # Test health endpoints
            echo "üîç Testing health endpoints..."
            curl -f http://localhost:85/health || (echo "‚ùå NGINX health check failed" && exit 1)
            
            echo "‚úÖ All services are running and healthy"
            echo "üéâ Backend deployment successful!"
