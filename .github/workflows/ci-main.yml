name: CI Pipeline [main]

on:
  push:
    branches: [main]

# Permissions for GHCR push and security scanning
permissions:
  contents: read
  packages: write
  security-events: write

env:
  REGISTRY: ghcr.io
  # Image names (lowercase required for GHCR)
  IMAGE_USER: ghcr.io/${{ github.repository_owner }}/chat-user-service
  IMAGE_CHAT: ghcr.io/${{ github.repository_owner }}/chat-chat-service
  IMAGE_NOTIFICATION: ghcr.io/${{ github.repository_owner }}/chat-notification-service
  IMAGE_NGINX: ghcr.io/${{ github.repository_owner }}/chat-nginx

jobs:
  build:
    name: Build & Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Build user-service
        working-directory: ./user-service
        run: |
          npm ci
          npm run build

      - name: Build chat-service
        working-directory: ./chat-service
        run: |
          npm ci
          npm run build

      - name: Build notification-service
        working-directory: ./notification-service
        run: |
          npm ci
          npm run build

      - name: Audit backends
        run: |
          npm audit --prefix user-service --audit-level=moderate || true
          npm audit --prefix chat-service --audit-level=moderate || true
          npm audit --prefix notification-service --audit-level=moderate || true

  typescript-check:
    name: TypeScript Type Check
    needs: build
    uses: ./.github/workflows/typescript-check.yml

  security-audit:
    name: Security Audit
    needs: typescript-check
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/security-audit.yml
    secrets: inherit

  unit-tests:
    name: Unit Tests & Coverage
    needs: security-audit
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/unit-tests.yml
    with:
      coverage: 'true'
    secrets: inherit

  # Build and push Docker images to GitHub Container Registry
  docker-build:
    name: Build & Push Docker Images
    needs: unit-tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push user-service
        uses: docker/build-push-action@v6
        with:
          context: ./user-service
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/chat-user-service:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/chat-user-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push chat-service
        uses: docker/build-push-action@v6
        with:
          context: ./chat-service
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/chat-chat-service:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/chat-chat-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push notification-service
        uses: docker/build-push-action@v6
        with:
          context: ./notification-service
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/chat-notification-service:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/chat-notification-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push nginx
        uses: docker/build-push-action@v6
        with:
          context: ./nginx
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/chat-nginx:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/chat-nginx:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to VPS - NO git clone/pull, only pull pre-built images
  deploy:
    name: Deploy to VPS
    needs: docker-build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production-deployment
      cancel-in-progress: false

    steps:
      - name: Fetch secrets from Infisical
        id: infisical
        uses: Infisical/secrets-action@v1.0.7
        with:
          method: universal
          client-id: ${{ secrets.INFISCAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISCAL_CLIENT_SECRET }}
          project-slug: ${{ secrets.INFISCAL_PROJECT_SLUG }}
          env-slug: prod
          secret-path: /

      - name: Validate secrets
        run: |
          echo "üîç Validating required secrets..."
          MISSING=0
          
          # Required secrets
          [ -z "$ADMIN_USERNAME" ] && echo "‚ùå ADMIN_USERNAME missing" && MISSING=1 || echo "‚úÖ ADMIN_USERNAME"
          [ -z "$ADMIN_PASSWORD" ] && echo "‚ùå ADMIN_PASSWORD missing" && MISSING=1 || echo "‚úÖ ADMIN_PASSWORD"
          [ -z "$ADMIN_PASSWORD_ENCODED" ] && echo "‚ùå ADMIN_PASSWORD_ENCODED missing" && MISSING=1 || echo "‚úÖ ADMIN_PASSWORD_ENCODED"
          
          # Email/SMTP secrets (warn if missing but don't fail)
          [ -z "$SMTP_HOST" ] && echo "‚ö†Ô∏è SMTP_HOST missing (defaulting to smtp-relay.brevo.com)" || echo "‚úÖ SMTP_HOST"
          [ -z "$EMAIL_FROM" ] && echo "‚ö†Ô∏è EMAIL_FROM missing (defaulting to admin@ctaprojects.xyz)" || echo "‚úÖ EMAIL_FROM"
          [ -z "$SMTP_USER" ] && echo "‚ö†Ô∏è SMTP_USER missing" || echo "‚úÖ SMTP_USER"
          [ -z "$SMTP_PASS" ] && echo "‚ö†Ô∏è SMTP_PASS missing" || echo "‚úÖ SMTP_PASS"
          
          # Mask sensitive values in logs
          echo "::add-mask::$ADMIN_PASSWORD"
          echo "::add-mask::$ADMIN_PASSWORD_ENCODED"
          echo "::add-mask::$SMTP_PASS"
          echo "::add-mask::$SENDINBLUE_APIKEY"
          
          [ "$MISSING" -eq 1 ] && exit 1
          echo "‚úÖ All required secrets validated"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          ADMIN_USERNAME: ${{ env.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ env.ADMIN_PASSWORD }}
          ADMIN_PASSWORD_ENCODED: ${{ env.ADMIN_PASSWORD_ENCODED }}
          CORS_ORIGINS: ${{ env.CORS_ORIGINS }}
          MESSAGE_BROKER_URL: ${{ env.MESSAGE_BROKER_URL }}
          SENDINBLUE_APIKEY: ${{ env.SENDINBLUE_APIKEY }}
          SMTP_HOST: ${{ env.SMTP_HOST }}
          SMTP_PASS: ${{ env.SMTP_PASS }}
          SMTP_USER: ${{ env.SMTP_USER }}
          EMAIL_FROM: ${{ env.EMAIL_FROM }}
          PGADMIN_EMAIL: ${{ secrets.PGADMIN_EMAIL }}
          VPS_SUDO_PASSWORD: ${{ secrets.VPS_SUDO_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ github.sha }}
          REPO_OWNER: ${{ github.repository_owner }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          envs: ADMIN_USERNAME,ADMIN_PASSWORD,ADMIN_PASSWORD_ENCODED,CORS_ORIGINS,MESSAGE_BROKER_URL,SENDINBLUE_APIKEY,SMTP_HOST,SMTP_PASS,SMTP_USER,EMAIL_FROM,PGADMIN_EMAIL,VPS_SUDO_PASSWORD,GITHUB_TOKEN,IMAGE_TAG,REPO_OWNER
          script: |
            set -euo pipefail
            DEPLOY_PATH="/opt/chat-app"

            echo "üöÄ Starting backend deployment (image-based, no git pull)..."

            # Mask sensitive env vars from logs
            echo "::add-mask::$VPS_SUDO_PASSWORD"
            echo "::add-mask::$GITHUB_TOKEN"
            echo "::add-mask::$ADMIN_PASSWORD"
            echo "::add-mask::$ADMIN_PASSWORD_ENCODED"
            
            # Create deploy directory with sudo (password piped securely)
            if [ ! -d "$DEPLOY_PATH" ]; then
              sudo -S mkdir -p "$DEPLOY_PATH" <<< "$VPS_SUDO_PASSWORD" 2>/dev/null
              sudo -S chown $USER:$USER "$DEPLOY_PATH" <<< "$VPS_SUDO_PASSWORD" 2>/dev/null
            fi

            cd "$DEPLOY_PATH"
            mkdir -p chat-microservices
            cd chat-microservices

            # Log in to GitHub Container Registry (token passed via stdin, not echoed)
            echo "üîê Logging in to GHCR..."
            docker login ghcr.io -u "$REPO_OWNER" --password-stdin <<< "$GITHUB_TOKEN" 2>/dev/null

            # Generate JWT secret if not exists
            JWT_SECRET_FILE="$DEPLOY_PATH/.jwt_secret"
            if [ ! -f "$JWT_SECRET_FILE" ]; then
              echo "üîë Generating new JWT secret..."
              openssl rand -base64 64 | tr -d '\n' > "$JWT_SECRET_FILE"
              chmod 600 "$JWT_SECRET_FILE"
            fi
            JWT_SECRET=$(cat "$JWT_SECRET_FILE")

            # Create docker-compose.yml directly (no git needed)
            echo "üìù Creating docker-compose.yml..."
            cat > docker-compose.yml << 'COMPOSE_END'
            services:
              postgres:
                image: postgres:17-bookworm
                restart: unless-stopped
                volumes:
                  - postgres-data:/var/lib/postgresql/data
                environment:
                  POSTGRES_USER: ${ADMIN_USERNAME}
                  POSTGRES_PASSWORD: ${ADMIN_PASSWORD}
                  POSTGRES_DB: chat_db
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${ADMIN_USERNAME} -d chat_db"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
                  start_period: 10s

              pgadmin:
                image: dpage/pgadmin4:latest
                restart: unless-stopped
                depends_on:
                  postgres:
                    condition: service_healthy
                ports:
                  - "127.0.0.1:8088:80"
                environment:
                  PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
                  PGADMIN_DEFAULT_PASSWORD: ${ADMIN_PASSWORD}
                  PGADMIN_CONFIG_SERVER_MODE: "False"
                volumes:
                  - pgadmin-data:/var/lib/pgadmin

              user:
                image: ghcr.io/${REPO_OWNER}/chat-user-service:${IMAGE_TAG}
                restart: always
                expose:
                  - "8081"
                environment:
                  NODE_ENV: production
                  PORT: "8081"
                  JWT_SECRET: ${JWT_SECRET}
                  DATABASE_URL: postgresql://${ADMIN_USERNAME}:${ADMIN_PASSWORD_ENCODED}@postgres:5432/chat_db
                  MESSAGE_BROKER_URL: ${MESSAGE_BROKER_URL}
                  CORS_ORIGINS: ${CORS_ORIGINS}
                depends_on:
                  postgres:
                    condition: service_healthy
                healthcheck:
                  test: ["CMD", "/nodejs/bin/node", "-e", "require('http').get('http://localhost:8081/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
                  interval: 10s
                  timeout: 5s
                  retries: 3
                  start_period: 10s

              chat:
                image: ghcr.io/${REPO_OWNER}/chat-chat-service:${IMAGE_TAG}
                restart: always
                expose:
                  - "8082"
                environment:
                  NODE_ENV: production
                  PORT: "8082"
                  JWT_SECRET: ${JWT_SECRET}
                  DATABASE_URL: postgresql://${ADMIN_USERNAME}:${ADMIN_PASSWORD_ENCODED}@postgres:5432/chat_db
                  MESSAGE_BROKER_URL: ${MESSAGE_BROKER_URL}
                  CORS_ORIGINS: ${CORS_ORIGINS}
                depends_on:
                  postgres:
                    condition: service_healthy
                healthcheck:
                  test: ["CMD", "/nodejs/bin/node", "-e", "require('http').get('http://localhost:8082/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
                  interval: 10s
                  timeout: 5s
                  retries: 3
                  start_period: 10s

              notification:
                image: ghcr.io/${REPO_OWNER}/chat-notification-service:${IMAGE_TAG}
                restart: always
                expose:
                  - "8083"
                environment:
                  NODE_ENV: production
                  PORT: "8083"
                  JWT_SECRET: ${JWT_SECRET}
                  DATABASE_URL: postgresql://${ADMIN_USERNAME}:${ADMIN_PASSWORD_ENCODED}@postgres:5432/chat_db
                  MESSAGE_BROKER_URL: ${MESSAGE_BROKER_URL}
                  SMTP_HOST: ${SMTP_HOST:-smtp-relay.brevo.com}
                  SMTP_PORT: "587"
                  SMTP_USER: ${SMTP_USER}
                  SMTP_PASS: ${SMTP_PASS}
                  SENDINBLUE_APIKEY: ${SENDINBLUE_APIKEY}
                  EMAIL_FROM: ${EMAIL_FROM:-admin@ctaprojects.xyz}
                  NOTIFICATIONS_QUEUE: NOTIFICATIONS
                  CORS_ORIGINS: ${CORS_ORIGINS}
                depends_on:
                  postgres:
                    condition: service_healthy
                healthcheck:
                  test: ["CMD", "/nodejs/bin/node", "-e", "require('http').get('http://localhost:8083/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
                  interval: 10s
                  timeout: 5s
                  retries: 3
                  start_period: 10s

              nginx:
                image: ghcr.io/${REPO_OWNER}/chat-nginx:${IMAGE_TAG}
                restart: always
                ports:
                  - "0.0.0.0:80:8080"
                  - "0.0.0.0:443:8443"
                volumes:
                  - ./certbot/conf:/etc/letsencrypt:ro
                  - ./certbot/www:/var/www/certbot:ro
                depends_on:
                  user:
                    condition: service_healthy
                  chat:
                    condition: service_healthy
                  notification:
                    condition: service_healthy
                  frontend:
                    condition: service_started
                healthcheck:
                  test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
                  interval: 10s
                  timeout: 5s
                  retries: 3
                  start_period: 10s

              frontend:
                image: ghcr.io/${REPO_OWNER}/chat-frontend:latest
                restart: always
                expose:
                  - "3000"
                environment:
                  NODE_ENV: production
                  PORT: "3000"
                  HOST: "0.0.0.0"
                  ORIGIN: https://chat.ctaprojects.xyz
                  PROTOCOL_HEADER: x-forwarded-proto
                  HOST_HEADER: x-forwarded-host
                healthcheck:
                  test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
                  interval: 10s
                  timeout: 5s
                  retries: 3
                  start_period: 15s

            volumes:
              postgres-data:
              pgadmin-data:
            COMPOSE_END

            # Export all environment variables
            export ADMIN_USERNAME ADMIN_PASSWORD ADMIN_PASSWORD_ENCODED
            export CORS_ORIGINS MESSAGE_BROKER_URL SENDINBLUE_APIKEY
            export SMTP_HOST SMTP_PASS SMTP_USER EMAIL_FROM PGADMIN_EMAIL
            export JWT_SECRET IMAGE_TAG REPO_OWNER

            # Create certbot directories
            mkdir -p certbot/conf certbot/www

            echo "üê≥ Pulling pre-built images from GHCR..."
            docker compose pull

            echo "üöÄ Starting services..."
            docker compose up -d --remove-orphans --force-recreate

            echo "‚è≥ Waiting for services to be healthy..."
            sleep 30

            # Verify health
            if curl -fsS http://localhost:80/health >/dev/null 2>&1; then
              echo "‚úÖ Backend deployment successful!"
            else
              echo "‚ö†Ô∏è Health check failed, showing logs..."
              docker compose logs --tail=100
              exit 1
            fi

            docker compose ps

      - name: Security cleanup
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        env:
          VPS_SUDO_PASSWORD: ${{ secrets.VPS_SUDO_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: VPS_SUDO_PASSWORD
          script: |
            echo "üîí Security cleanup..."
            DEPLOY_PATH="/opt/chat-app"
            
            # Mask sudo password
            echo "::add-mask::$VPS_SUDO_PASSWORD"
            
            cd "$DEPLOY_PATH/chat-microservices" 2>/dev/null || exit 0
            
            # Remove git data and source files
            rm -rf .git .github 2>/dev/null || true
            rm -rf user-service chat-service notification-service nginx 2>/dev/null || true
            rm -rf scripts deploy docs docker-secrets 2>/dev/null || true
            
            # Prune Docker
            docker image prune -f || true
            docker container prune -f || true
            
            echo "‚úÖ Security cleanup complete!"
            echo "üìä Remaining files:"
            ls -la
